# A股/港股 融合交易平台技术方案与开发路线规划（优化完整版）

> 基于两份分析报告融合产出：
> - `NOFX_技术分析报告.md`（交易执行/回测/风险控制一体化思路）
> - `TradingAgents-CN_技术分析报告.md`（多智能体分析框架与数据多源集成思路）
>
> 目标：使用 **Python** 实现 **A股 + 港股** 的分析与交易系统（非加密货币），具备“分析 → 决策 → 风控 → 回测 → 实盘”的完整闭环。

---

## 0. 版本与范围

- **版本号**：v0.1 方案
- **市场范围**：A股（沪深 + 北交）/港股（主板 + 创业板）
- **用户范围**：研究者 / 量化交易者 / 机构内部工具
- **运行模式**：
  - 研究模式（仅分析+回测）
  - 模拟模式（Paper Trading）
  - 实盘模式（券商 API）

---

## 1. 融合原则与总体目标

### 1.1 融合原则
- **TradingAgents-CN 的“分析智能体”能力** → 作为上游“分析/建议层”。
- **NOFX 的“执行/回测/风控闭环”能力** → 作为下游“交易执行层”。
- **策略与风控必须解耦**：AI 仅输出建议，风控与交易执行在系统侧强制完成。

### 1.2 总体目标
- 构建可复用、可扩展的 Python 架构，覆盖：
  - 多源市场数据（行情、基本面、公告、新闻）
  - 多智能体分析编排
  - 结构化决策与强校验
  - 回测/实盘一致的交易引擎
  - A股/港股交易规则适配

---

## 2. 总体架构（服务拆分版）

```
┌─────────────────────────────────────────────────────────────────────┐
│                                Web UI                                │
│  策略配置 | 组合监控 | 回测报告 | 交易审计 | 预警与通知                │
└───────────────┬─────────────────────────────────────────────────────┘
                │ HTTPS / WebSocket / SSE
┌───────────────▼─────────────────────────────────────────────────────┐
│                              API Gateway                             │
│  FastAPI | 认证 | RBAC | 速率限制 | 日志 | 配置中心                   │
└───────────────┬─────────────────────────────────────────────────────┘
                │
┌───────────────▼─────────────────────────────────────────────────────┐
│                           Core Services（Python）                     │
│  1) Analysis Service（多智能体编排）                                  │
│  2) Strategy Service（策略版本/参数）                                 │
│  3) Decision Engine（结构化决策 + 校验）                              │
│  4) Risk Service（硬风控）                                            │
│  5) Execution Service（下单/撮合/同步）                               │
│  6) Backtest Service（历史回测）                                      │
│  7) Portfolio Service（组合统计/绩效）                                │
│  8) Notification Service（告警/通知）                                 │
└───────────────┬─────────────────────────────────────────────────────┘
                │
┌───────────────▼─────────────────────────────────────────────────────┐
│                            Data Layer                                │
│  Data Adapter：AKShare / Tushare / BaoStock / YFinance / 券商行情      │
└───────────────┬─────────────────────────────────────────────────────┘
                │
┌───────────────▼─────────────────────────────────────────────────────┐
│                      Storage & Cache Layer                           │
│  PostgreSQL/MongoDB(结构化数据) | Redis(缓存/任务) | 文件存储           │
└───────────────┬─────────────────────────────────────────────────────┘
                │
┌───────────────▼─────────────────────────────────────────────────────┐
│                          Broker Adapter Layer                         │
│  IBKR / Futu / Tiger / QMT / XTP / Paper Broker                        │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 3. 模块边界与职责定义

### 3.1 模块责任表

| 模块 | 输入 | 输出 | 责任 | 备注 |
|---|---|---|---|---|
| Data Service | 市场/基本面/公告请求 | 标准化数据 | 数据拉取、清洗、复权、缓存 | 交易日历/复权处理关键 |
| Analysis Service | 标准化数据、上下文 | 分析报告/评分/建议 | 多智能体分析编排 | 可异步任务 |
| Decision Engine | 分析建议 | 结构化决策 JSON | 决策结构化、校验 | 不直接下单 |
| Risk Service | 决策、账户 | 风控通过/拒绝 | 强约束（规则/阈值） | 必须与交易解耦 |
| Execution Service | 风控通过的决策 | 订单/成交 | 下单、撤单、同步 | 支持 Broker 插件 |
| Backtest Service | 策略+数据 | 回测结果 | 仿真交易 | 与实盘数据结构一致 |
| Portfolio Service | 订单/成交/仓位 | 绩效指标 | 统计与报表 | 夏普/回撤等 |
| Notification Service | 风险/异常 | 通知 | 邮件/短信/IM | 可选 |

---

## 4. A股/港股适配与关键差异

### 4.1 交易规则差异（必须硬编码到风控层）

| 维度 | A股 | 港股 |
|---|---|---|
| 交易制度 | T+1 | 可日内买卖（T+0） |
| 涨跌幅 | 主板 10%，科创/创业板 20% | 无涨跌停（但有波动机制） |
| 交易单位 | 100 股/手 | 按 Board Lot，股票不同 |
| 交易时段 | 上午+下午，午间休市 | 连续交易+午休较短 |
| 费用 | 佣金+印花税+过户费等 | 佣金+印花税+交易征费+结算费 |

### 4.2 必要的系统层约束
- **交易日历与节假日**：必须使用交易日历服务校验。
- **复权处理**：历史回测要统一复权口径（前复权/后复权）。
- **公司行为**：分红、送股、拆合股必须调整历史价量。
- **停牌/除权日**：策略下单必须过滤不可交易标的。
- **港股最小买卖单位**：下单必须校验 Board Lot。

---

## 5. 数据源与券商适配清单

### 5.1 数据源矩阵（建议）

| 数据类型 | A股推荐 | 港股推荐 | 备注 |
|---|---|---|---|
| 实时行情 | 券商行情 / AKShare | 券商行情 / YFinance | 实时性与稳定性要求高 |
| 历史行情 | Tushare / BaoStock | AKShare HK / YFinance | 需复权处理 |
| 基本面 | Tushare | YFinance / 财报数据 | 财报字段差异大 |
| 资金流/持仓 | 付费数据商 | 付费数据商 | 可作为进阶 |
| 新闻公告 | RSS / 资讯 API | RSS / 交易所公告 | 需要文本清洗 |

> **建议策略**：初期用免费数据源快速闭环，后期升级为商业数据源。

### 5.2 券商适配建议

| 券商/接口 | 适配方式 | 适用市场 | 备注 |
|---|---|---|---|
| IBKR | 官方 API / Gateway | 港股 + 美股 | 稳定但有门槛 |
| Futu OpenD | 开放接口 | 港股/美股 | 社区常用 |
| Tiger | 开放接口 | 港股/美股 | SDK 友好 |
| QMT | 本地客户端接口 | A股 | 通常 Windows 环境 |
| XTP | C++/Python SDK | A股 | 机构级 |
| Paper Broker | 自研 | A股/港股 | 默认上线模式 |

> A股实盘往往受制于券商 API 与合规要求，建议先实现 Paper 模式。

---

## 6. 风控体系（硬风控 + 软风控）

### 6.1 硬风控（系统强制）
- 最大仓位比例（单标的 / 总组合）
- 最大日亏损 / 最大回撤阈值
- 最低现金比例（防止满仓）
- 单笔订单最大金额
- A股涨跌停限制 / 港股 Board Lot 校验
- 停牌/除权/交易日校验

### 6.2 软风控（AI建议）
- 多 Agent 一致性评分
- AI 置信度阈值
- 趋势一致性与波动异常过滤

### 6.3 风控指标建议
- Max DD / VaR / CVaR
- 行业集中度
- 单票仓位占比
- 交易频率阈值

---

## 7. 关键时序流程（ASCII 时序）

### 7.1 分析 → 决策 → 交易流程
```
[Data] -> [Agents] -> [Decision Engine] -> [Risk Service] -> [Execution]
   |         |              |                   |              |
行情/财报   多智能体       输出结构化         风控拒绝/通过     下单/回写
```

### 7.2 回测流程
```
历史数据 -> 时间推进 -> 决策 -> 模拟成交 -> 绩效计算 -> 报告输出
```

### 7.3 仓位同步流程
```
定时任务 -> Broker 拉取仓位/订单 -> 本地数据库对账 -> 异常告警
```

---

## 8. 技术栈与落地选型（Python）

| 领域 | 推荐 | 说明 |
|---|---|---|
| API | FastAPI + Uvicorn | 异步接口、OpenAPI 文档 |
| ORM | SQLAlchemy + Alembic | 数据模型与迁移 |
| 缓存 | Redis | 任务/进度/热点数据 |
| 数据分析 | Pandas / Polars | 指标计算 |
| AI | LangGraph / LangChain | 多智能体编排 |
| 任务 | Celery / Arq | 异步任务调度 |
| 日志 | structlog / loguru | 结构化日志 |
| 监控 | OpenTelemetry | 可观测性 |
| 回测 | 自研框架或 Backtrader | 与实盘一致性优先 |

---

## 9. 推荐代码结构（目录规划）

```
project/
  apps/
    api/                # FastAPI 入口
  core/
    config/             # 配置加载
    models/             # ORM/Pydantic
    schema/             # 决策/策略 JSON schema
  services/
    data/               # 数据拉取与缓存
    analysis/           # 多智能体分析
    decision/           # 决策引擎
    risk/               # 风控规则
    execution/          # 交易执行
    backtest/           # 回测引擎
    portfolio/          # 组合绩效
  brokers/
    paper/              # 模拟券商
    futu/               # 港股接口
    ibkr/
    qmt/
  infra/
    docker/
    migrations/
  tests/
```

---

## 10. 详细开发路线与里程碑

### Phase 0（1-2 周）：基础设施
- FastAPI + DB + Redis 架构搭建
- 统一数据模型（股票/订单/仓位/决策）
- 基础交易日历服务

**交付物**：API 骨架 + 数据表结构 + 模块框架

---

### Phase 1（3-4 周）：分析系统 MVP
- 接入 A股 + 港股基础数据
- 集成多智能体分析（LangGraph）
- 输出结构化分析报告

**交付物**：`/analysis/run` API，支持 JSON 报告输出

---

### Phase 2（4-6 周）：策略与回测
- 策略版本管理
- 回测引擎（仿真成交 + 绩效指标）
- 结果持久化与回放

**交付物**：`/backtest/start` API + 回测报告

---

### Phase 3（6-8 周）：执行与风控
- Broker 接口 + Paper Trading
- 风控规则集成
- 订单/仓位同步机制

**交付物**：`/trade/execute` + 风控拒绝机制

---

### Phase 4（4-6 周）：实盘适配
- 接入 1-2 家券商（港股优先）
- 执行审计与交易日志
- 异常处理与自动恢复

**交付物**：实盘交易闭环

---

### Phase 5（4-6 周）：可视化与运维
- 前端策略/回测管理
- 绩效仪表盘
- 告警系统

**交付物**：Web UI + 运维监控

---

## 11. 人员与分工建议

| 角色 | 任务 |
|---|---|
| 架构/技术负责人 | 设计与技术路线把控 |
| 后端工程师 | API + 执行 + 风控 |
| 数据工程师 | 数据源接入与清洗 |
| 算法/量化 | 策略研究与回测 |
| 前端工程师 | Web 管理台 |
| DevOps | 部署与监控 |

---

## 12. 成本与性能策略

### 12.1 成本
- 数据源成本：免费 → 商业化（需预算）。
- AI 模型成本：按 Token 计费，需缓存与限频。
- 运维成本：建议先 Docker Compose，后期可迁移 Kubernetes。

### 12.2 性能优化
- 行情数据层缓存（Redis + 本地缓存）。
- AI 请求去重（同一标的 + 同一时间窗口）。
- 回测批处理（异步任务队列）。
- 日志分级与批量入库。

---

## 13. 合规与安全注意事项

- 实盘交易需符合券商与监管规则。
- 必须提示用户风险与免责条款。
- API Key / 密钥需加密存储与传输。
- 账户操作必须审计可追踪。

---

## 14. 结论

通过整合 NOFX 的“执行/回测/风控一体化”与 TradingAgents-CN 的“多智能体分析编排”，可以在 Python 生态中快速构建一个面向 A股/港股的专业分析与交易平台。建议优先完成 **分析 + 回测 + Paper Trading**，待系统稳定后再接入实盘券商。

---


---

## 15. 多 AI 竞赛模块（NOFX 思路迁移）

> 目标：在 A/HK 场景复现 NOFX 的“多 AI Trader 竞赛”，用于策略对比与稳健性评估。竞赛默认运行在 **回测或 Paper Trading**，实盘需强约束。

### 15.1 模块划分与职责

- **Competition Manager**
  - 创建/启动/停止竞赛
  - 协调数据快照与调度周期
- **Market Snapshot Bus**
  - 统一时间戳行情与基本面数据
  - 避免各参赛者获取“不同步”数据
- **AI Trader Pool**
  - 每个 AI Trader 绑定一个模型 + 策略配置
  - 独立账户/仓位/风险控制
- **Risk Engine（强制）**
  - A/HK 交易规则校验
  - 资金与仓位阈值
- **Scoring Engine**
  - 统一绩效指标与权重
  - 输出排行榜
- **Audit & Replay**
  - 保存决策日志、订单与权益曲线
  - 支持回放

### 15.2 时序图（ASCII）

#### 15.2.1 回测竞赛时序
```
[Competition Manager]
      |
      | 生成统一回测时间轴
      v
[Market Snapshot Bus] -----> 向所有参赛者广播相同快照
      |
      v
[AI Trader Pool] -> 每个 Trader 生成决策
      |
      v
[Risk Engine] -> 校验(拒绝/通过)
      |
      v
[Backtest Execution] -> 撮合成交 -> 记录订单/权益
      |
      v
[Scoring Engine] -> 计算指标 -> Leaderboard
```

#### 15.2.2 Paper Trading 竞赛时序
```
[Market Snapshot Bus] -> 实时行情推送
      |
      v
[AI Trader Pool] -> 决策 -> 风控
      |
      v
[Paper Broker] -> 模拟成交 -> 存储日志
      |
      v
[Scoring Engine] -> 实时榜单更新（SSE/WebSocket）
```

### 15.3 评分指标体系（建议权重）

> 评分需区分“收益型”与“稳健型”。建议提供两套可切换权重。

**默认稳健型权重示例：**
- 总收益率（Total Return）: 30%
- 最大回撤（Max Drawdown）: 25%
- 夏普比率（Sharpe）: 20%
- 胜率（Win Rate）: 10%
- 交易成本占比（Cost Ratio）: 10%
- 最大连亏（Max Losing Streak）: 5%

**收益型权重示例：**
- 总收益率: 45%
- 最大回撤: 15%
- 夏普: 15%
- 胜率: 10%
- 交易成本占比: 10%
- 最大连亏: 5%

### 15.4 数据一致性与防偏差机制

为避免竞赛结果受数据差异影响，必须实施：
- **时间对齐**：所有 Trader 使用同一时间戳快照。
- **数据冻结**：回测模式使用冻结历史数据集。
- **统一复权口径**：同一回测内一致使用前/后复权。
- **交易成本统一**：佣金、滑点、税费统一模型。
- **交易日历统一**：非交易日禁止决策。
- **延迟模拟**（选配）：设定统一决策延迟（如 1 根 K 线后成交）。

### 15.5 API 设计（竞赛相关）

- `POST /competitions` 创建竞赛
- `POST /competitions/{id}/start` 启动
- `POST /competitions/{id}/stop` 停止
- `GET /competitions/{id}/status` 状态
- `GET /competitions/{id}/leaderboard` 排行榜
- `GET /competitions/{id}/stream` 实时推送
- `GET /competitions/{id}/participants` 参赛者配置

### 15.6 前端 UI 草案与路由建议

**页面结构：**
- `/competition`：竞赛首页
- `/competition/:id`：竞赛详情（排行榜 + 交易明细）
- `/competition/:id/trader/:traderId`：单一 Trader 视图
- `/competition/create`：创建竞赛向导

**核心组件建议：**
- 竞赛榜单卡片（LeaderboardCard）
- Trader 绩效曲线（EquityChart）
- 决策日志面板（DecisionLogPanel）
- 交易明细表（TradesTable）

---

## 16. 多 AI 竞赛纳入开发路线

建议在 Phase 2（回测）后插入竞赛子阶段：

- **Phase 2.5（2-3 周）**：
  - 完成 Competition Manager
  - 实现回测竞赛榜单
  - 实现 SSE 推送竞赛状态

- **Phase 3.5（2-3 周）**：
  - 实现 Paper 竞赛
  - 支持多 Trader 并行运行

实盘竞赛仅建议在 Phase 4 之后，并配置“人工确认开关”。

---

## 17. 竞赛模块风险与合规说明

- **回测竞赛**：无合规风险，但需标注“历史表现不代表未来”。
- **Paper 竞赛**：禁止模拟收益宣传，必须提示“非真实收益”。
- **实盘竞赛**：若涉及多账户管理，需券商合规支持。

---

